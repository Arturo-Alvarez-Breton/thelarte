<!DOCTYPE html>
<html lang="es">
<head>
    <script src="/webjars/html2canvas/1.4.1/dist/html2canvas.min.js"></script>
    <script src="/webjars/jspdf/2.5.1/dist/jspdf.umd.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador - Transacciones</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="/css/output.css" rel="stylesheet">
    <script>
        // Define tailwind object for configuration
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            'brand-brown': '#4A3228',
                            'brand-beige': '#F5F5DC',
                            'brand-light-brown': '#8B4513',
                            'brand-accent': '#D2B48C',
                            'brandGold': '#7B5222'
                        }
                    }
                }
            }
        };
    </script>
    <style>
        .transaction-card {
            transition: all 0.3s ease;
            max-width: 480px;
        }
        .transaction-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        @media (min-width:1280px){#transaccionesListContainer{justify-items:center;gap:1rem}}
        @media (min-width:1080px){#transaccionesListContainer{gap:.75rem!important}}
        @media (min-width:1536px){#transaccionesListContainer{gap:2rem}.transaction-card{max-width:420px}}
        @media (min-width:1920px){#transaccionesListContainer{gap:1.5rem}.transaction-card{max-width:480px}}
        .loading-spinner{animation:spin 1s linear infinite}
        @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    </style>

    <!-- Scripts adicionales para la integración con el terminal -->
    <script type="module">
        // Crear archivo TerminalPaymentProcessor.js en js/components/TerminalPaymentProcessor.js
        const terminalPaymentProcessorScript = document.createElement('script');
        terminalPaymentProcessorScript.type = 'module';
        terminalPaymentProcessorScript.src = '/js/components/TerminalPaymentProcessor.js';
        document.head.appendChild(terminalPaymentProcessorScript);

        // Crear o actualizar CardnetService.js en js/services/cardnetService.js
        const cardnetServiceScript = document.createElement('script');
        cardnetServiceScript.type = 'module';
        cardnetServiceScript.src = '/js/services/cardnetService.js';
        document.head.appendChild(cardnetServiceScript);
    </script>
</head>
<body class="flex h-screen bg-gray-100 overflow-x-hidden">
<!-- Mobile Sidebar Overlay -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
<!-- Sidebar -->
<aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-brand-brown text-white p-4 space-y-4 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0">
    <button id="closeSidebarBtn" class="lg:hidden absolute top-4 right-4 text-white hover:text-gray-300"><i class="fas fa-times text-xl"></i></button>
    <div class="text-2xl font-bold text-center mb-8">Thelarte</div>
    <nav class="flex-1">
        <ul class="space-y-2">
            <li><a href="/pages/admin/index.html" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fas fa-home w-6 h-6"></i><span class="ml-3">Inicio Admin</span></a></li>
            <li><a href="/pages/admin/clientes.html" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fas fa-users w-6 h-6"></i><span class="ml-3">Clientes</span></a></li>
            <li><a href="/pages/admin/empleados.html" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fas fa-briefcase w-6 h-6"></i><span class="ml-3">Empleados</span></a></li>
            <li><a href="/pages/admin/usuarios.html" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fa-regular fa-user w-6 h-6"></i><span class="ml-3">Usuarios</span></a></li>
            <li><a href="/pages/admin/suplidores.html" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fas fa-truck w-6 h-6"></i><span class="ml-3">Suplidores</span></a></li>
            <li><a href="/pages/admin/transacciones.html" class="group flex items-center p-2 rounded-lg bg-brand-light-brown"><i class="fas fa-exchange-alt w-6 h-6"></i><span class="ml-3">Transacciones</span></a></li>
            <li><a href="/pages/admin/productos.html" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fas fa-box-open w-6 h-6"></i><span class="ml-3">Productos</span></a></li>
            <li><a href="/pages/admin/reportes.html" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fas fa-chart-line w-6 h-6"></i><span class="ml-3">Reportes</span></a></li>
            <li><a href="/pages/admin/config.html" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fas fa-cog w-6 h-6"></i><span class="ml-3">Configuración</span></a></li>
        </ul>
    </nav>
    <div class="mt-auto"><a href="#" id="logoutBtn" class="group flex items-center p-2 rounded-lg hover:bg-brand-light-brown"><i class="fas fa-sign-out-alt w-6 h-6"></i><span class="ml-3">Cerrar Sesión</span></a></div>
</aside>
<!-- Contenido principal -->
<div class="flex-1 flex flex-col min-w-0">
    <!-- Header responsive -->
    <header class="bg-white shadow p-2 md:p-4 flex flex-col sm:flex-row justify-between items-center gap-2">
        <div class="flex items-center w-full">
            <button id="hamburgerBtn" class="lg:hidden mr-3 text-gray-600 hover:text-gray-900"><i class="fas fa-bars text-xl"></i></button>
            <div>
                <h1 id="cont-header-title" class="text-lg md:text-2xl font-bold text-gray-800">Transacciones</h1>
                <p id="cont-header-subtitle" class="text-xs md:text-sm text-gray-600 hidden sm:block">Consulta de transacciones y registro de operaciones de caja</p>
            </div>
        </div>
        <div id="cont-quick-actions" class="flex flex-wrap gap-2 w-full sm:w-auto overflow-x-auto">
            <button id='btnVenta' data-action="open-wizard" data-type="VENTA" class="bg-brand-brown text-white px-3 md:px-4 py-2 rounded-lg hover:bg-brand-light-brown flex items-center text-sm md:text-base"><i class="fas fa-plus mr-2"></i><span>Nueva Venta</span></button>
            <button id='btnCompra' data-action="open-wizard" data-type="COMPRA" class="bg-brand-brown text-white px-3 md:px-4 py-2 rounded-lg hover:bg-brand-light-brown flex items-center text-sm md:text-base"><i class="fas fa-shopping-cart mr-2"></i><span>Nueva Compra</span></button>
            <button id='btnDevolucion' data-action="open-wizard" data-type="DEVOLUCION" class="bg-brand-brown text-white px-3 md:px-4 py-2 rounded-lg hover:bg-brand-light-brown flex items-center text-sm md:text-base"><i class="fas fa-undo mr-2"></i><span>Devolución</span></button>
        </div>
    </header>
    <main id="cont-main-content" class="flex-1 p-2 md:p-4 overflow-auto min-w-0">
        <section class="p-3 md:p-4 bg-white rounded-lg shadow">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                <h2 class="text-lg md:text-xl font-semibold text-gray-700">Lista de Transacciones</h2>
                <div class="w-full sm:w-auto"></div>
            </div>
            <div class="mb-4 flex flex-wrap gap-4">
                <input type="text" id="transaccionSearchInput" placeholder="Buscar transacciones..." class="flex-1 min-w-64 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-brown focus:border-brand-brown text-sm md:text-base">
                <select id="transaccionTipoFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-brown focus:border-brand-brown">
                    <option value="">Todos los tipos</option>
                    <option value="VENTA">Ventas</option>
                    <option value="COMPRA">Compras</option>
                    <option value="DEVOLUCION_VENTA">Devoluciones de Ventas</option>
                    <option value="DEVOLUCION_COMPRA">Devoluciones de Compras</option>
                </select>
                <select id="transaccionEstadoFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-brown focus:border-brand-brown">
                    <option value="">Todos los estados</option>
                    <option value="PENDIENTE">Pendiente</option>
                    <option value="CONFIRMADA">Confirmada</option>
                    <option value="PROCESANDO">Procesando</option>
                    <option value="COMPLETADA">Completada</option>
                    <option value="CANCELADA">Cancelada</option>
                    <option value="FACTURADA">Facturada</option>
                    <option value="DEVUELTA">Devuelta</option>
                    <option value="PARCIALMENTE_DEVUELTA">Parcialmente devuelta</option>
                </select>
            </div>
            <!-- Botones de vista agregados -->
            <div class="mb-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-700">Vista:</span>
                    <div class="bg-gray-100 rounded-lg p-1 flex">
                        <button id="btnVistaTarjetas" class="px-3 py-1 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm">
                            <i class="fas fa-th-large mr-1"></i>Tarjetas
                        </button>
                        <button id="btnVistaTabla" class="px-3 py-1 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
                            <i class="fas fa-table mr-1"></i>Tabla
                        </button>
                    </div>
                </div>
                <div id="totalTransacciones" class="text-sm text-gray-600"></div>
            </div>
            <div id="transaccionesListContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3 md:gap-4 lg:gap-3"></div>
            <div id="transaccionesTableContainer" class="hidden mt-4 overflow-x-auto"></div>
            <div id="paginacion" class="mt-6 flex justify-center"></div>
        </section>
    </main>
</div>

<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-brand-beige" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>
<!-- Modal Ver Transacción -->
<div id="modalVerTransaccion" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-hidden">
            <div class="bg-brand-brown text-white p-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Detalles de Transacción</h3>
                    <button onclick="cerrarModalVerTransaccion()" class="text-white hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 max-h-96 overflow-y-auto" id="detallesTransaccion"></div>
            <div class="bg-gray-50 px-6 py-4 flex items-center justify-end space-x-3 border-t border-gray-200">
                <button onclick="imprimirFactura()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-print mr-2"></i>
                    Imprimir
                </button>
                <button onclick="cerrarModalVerTransaccion()" class="ver-btn flex items-center gap-2 bg-brand-brown text-white px-3 py-2 rounded-lg hover:bg-brand-light-brown transition-colors shadow-sm text-sm font-medium">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Creation Wizard Modal -->
<div id="transactionWizard" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-hidden">
            <div class="bg-brand-brown text-white p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-xl font-bold">Crear Nueva Transacción</h3>
                        <p class="text-brand-beige opacity-90" id="wizardSubtitle">Selecciona el tipo de transacción</p>
                    </div>
                    <button onclick="closeTransactionWizard()" class="text-white hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="wizardSteps" class="flex items-center mt-6 space-x-4"></div>
            </div>
            <div class="p-6 custom-scrollbar overflow-y-auto" style="max-height: 60vh;" id="wizardContent"></div>
            <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t border-gray-200">
                <button id="wizardPrevBtn" onclick="wizardPrevStep()" class="px-4 py-2 text-gray-600 hover:text-gray-800 hidden">
                    <i class="fas fa-arrow-left mr-1"></i>
                    Anterior
                </button>
                <div class="flex space-x-3">
                    <button onclick="closeTransactionWizard()" class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg">
                        Cancelar
                    </button>
                    <button id="wizardNextBtn" onclick="wizardNextStep()" class="px-6 py-2 bg-brand-brown text-white rounded-lg hover:bg-brand-light-brown">
                        Siguiente
                        <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pago con Terminal - AÑADIDO -->
<div id="terminalPaymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
            <div class="bg-brand-brown text-white p-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold">Pago con Terminal</h3>
                    <button onclick="cancelTerminalPayment()" class="text-white hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="terminalPaymentStatus" class="mb-4">
                    <div class="flex items-center justify-center mb-4">
                        <div class="animate-spin h-10 w-10 border-4 border-brand-brown border-t-transparent rounded-full"></div>
                    </div>
                    <p class="text-center text-lg font-medium" id="terminalStatusMessage">
                        Enviando transacción al terminal...
                    </p>
                    <p class="text-center text-gray-600 mt-2" id="terminalInstructions">
                        Por favor espere mientras se procesa la solicitud.
                    </p>
                </div>

                <div id="terminalPaymentComplete" class="text-center hidden">
                    <div class="bg-green-100 text-green-800 p-4 rounded-lg mb-4">
                        <i class="fas fa-check-circle text-3xl text-green-500 mb-2"></i>
                        <p class="font-bold">¡Pago completado exitosamente!</p>
                        <p id="terminalAuthCode" class="mt-1"></p>
                    </div>
                    <button onclick="closeTerminalPaymentModal()"
                            class="bg-brand-brown text-white px-4 py-2 rounded-lg hover:bg-brand-light-brown">
                        Cerrar
                    </button>
                </div>

                <div id="terminalPaymentError" class="text-center hidden">
                    <div class="bg-red-100 text-red-800 p-4 rounded-lg mb-4">
                        <i class="fas fa-exclamation-circle text-3xl text-red-500 mb-2"></i>
                        <p class="font-bold">Error en la transacción</p>
                        <p id="terminalErrorMessage" class="mt-1"></p>
                    </div>
                    <button onclick="closeTerminalPaymentModal()"
                            class="bg-brand-brown text-white px-4 py-2 rounded-lg hover:bg-brand-light-brown">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/js/components/sidebar.js" type="module"></script>
<script src="/js/components/header.js" type="module"></script>

<script src="/js/admin/main.js" type="module"></script>
<script src="/js/components/notifications.js" type="module"></script>
<script src="/js/components/transactionWizard.js" type="module"></script>
<script src="/js/services/transaccionService.js" type="module"></script>
<script src="/js/admin/transacciones.js" type="module"></script>
<script src="/js/services/logoutHandler.js"></script>


<!-- Script para las funciones globales del terminal - AÑADIDO -->
<script>
    // Funciones globales para el modal de pago con terminal
    window.procesarPagoTerminal = (id) => window.transaccionesManager?.procesarPagoTerminal(id);
    window.cancelTerminalPayment = () => window.transaccionesManager?.cancelTerminalPayment();
    window.closeTerminalPaymentModal = () => window.transaccionesManager?.closeTerminalPaymentModal();
</script>

<!-- Script para crear los archivos de componentes necesarios - AÑADIDO -->
<script>
    // Crear archivo TerminalPaymentProcessor.js si no existe
    fetch('/js/components/TerminalPaymentProcessor.js')
        .then(response => {
            if (!response.ok) {
                console.log('Creando archivo TerminalPaymentProcessor.js');
                const terminalPaymentProcessorContent = `
export class TerminalPaymentProcessor {
    constructor(cardnetService) {
        this.cardnetService = cardnetService;
        this.pollingInterval = null;
        this.statusCheckFrequency = 3000; // Consultar cada 3 segundos
        this.maxPollingTime = 300000; // 5 minutos máximo
        this.startTime = 0;
        this.onStatusChange = null;
        this.onComplete = null;
        this.onError = null;
    }

    /**
     * Inicia un proceso de pago con terminal físico
     * @param {Object} paymentData - Datos de pago
     * @param {Function} onStatusChange - Callback para cambios de estado
     * @param {Function} onComplete - Callback para pago completado
     * @param {Function} onError - Callback para errores
     */
    async startPayment(paymentData, onStatusChange, onComplete, onError) {
        try {
            // Registrar callbacks
            this.onStatusChange = onStatusChange;
            this.onComplete = onComplete;
            this.onError = onError;

            // Crear sesión
            const sessionData = await this.cardnetService.createSession(paymentData);

            if (!sessionData || !sessionData.SESSION) {
                throw new Error("No se pudo iniciar la sesión de pago");
            }

            const sessionId = sessionData.SESSION;
            const sessionKey = sessionData['session-key'];

            // Notificar que la sesión fue creada
            if (this.onStatusChange) {
                this.onStatusChange({
                    status: 'CREATED',
                    message: 'Sesión de pago creada. Esperando confirmación en terminal.',
                    sessionId,
                    sessionKey
                });
            }

            // Iniciar el polling para consultar estado
            this.startPolling(sessionId);

            return { sessionId, sessionKey };
        } catch (error) {
            console.error("Error iniciando pago en terminal:", error);
            if (this.onError) {
                this.onError(error);
            }
            throw error;
        }
    }

    /**
     * Inicia consultas periódicas al servidor para verificar estado
     */
    startPolling(sessionId) {
        this.startTime = Date.now();

        // Cancelar cualquier polling existente
        this.stopPolling();

        // Iniciar nuevo polling
        this.pollingInterval = setInterval(async () => {
            try {
                const statusData = await this.cardnetService.checkStatus(sessionId);

                // Notificar el cambio de estado
                if (this.onStatusChange) {
                    this.onStatusChange(statusData);
                }

                // Si la transacción está completada
                if (statusData.isCompleted) {
                    this.stopPolling();
                    if (this.onComplete) {
                        this.onComplete(statusData);
                    }
                }

                // Si ha pasado el tiempo máximo, detener
                if (Date.now() - this.startTime > this.maxPollingTime) {
                    this.stopPolling();
                    if (this.onError) {
                        this.onError(new Error("Tiempo de espera agotado para la transacción"));
                    }
                }

            } catch (error) {
                console.error("Error consultando estado:", error);
                if (this.onError) {
                    this.onError(error);
                }
                this.stopPolling();
            }
        }, this.statusCheckFrequency);
    }

    /**
     * Detiene las consultas de estado
     */
    stopPolling() {
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
            this.pollingInterval = null;
        }
    }

    /**
     * Cancela una transacción en curso
     */
    cancelTransaction() {
        this.stopPolling();
        if (this.onStatusChange) {
            this.onStatusChange({
                status: 'CANCELLED_BY_USER',
                message: 'Transacción cancelada por el usuario'
            });
        }
    }
}`;

                // Enviar al servidor (simulación - en realidad necesitarías crear estos archivos con acceso al sistema de archivos)
                console.log('Contenido de TerminalPaymentProcessor.js generado');
            }
        });

    // Crear archivo cardnetService.js si no existe
    fetch('/js/services/cardnetService.js')
        .then(response => {
            if (!response.ok) {
                console.log('Creando archivo cardnetService.js');
                const cardnetServiceContent = `
export class CardnetService {
    constructor() {
        this.apiUrl = '/api/payments'; // URL a tu API backend
    }

    /**
     * Crea una sesión de pago usando el backend para terminal físico
     * @param {Object} paymentData - Datos de la transacción
     * @returns {Promise<Object>} - Respuesta con SESSION y session-key
     */
    async createSession(paymentData) {
        try {
            const response = await fetch(\`\${this.apiUrl}/create-session\`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(this.preparePaymentData(paymentData))
            });

            if (!response.ok) {
                throw new Error(\`Error al crear sesión de pago: \${response.status}\`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error en CardnetService.createSession:', error);
            throw error;
        }
    }

    /**
     * Consulta el estado de una transacción en el terminal físico
     * @param {string} sessionId - ID de sesión
     * @returns {Promise<Object>} - Estado actual de la transacción
     */
    async checkStatus(sessionId) {
        try {
            const response = await fetch(\`\${this.apiUrl}/status/\${sessionId}\`, {
                method: 'GET'
            });

            if (!response.ok) {
                throw new Error(\`Error al consultar estado: \${response.status}\`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error en CardnetService.checkStatus:', error);
            throw error;
        }
    }

    /**
     * Verifica el resultado de una transacción usando el backend
     * @param {string} sessionId - ID de sesión
     * @param {string} sessionKey - Clave de sesión
     * @returns {Promise<Object>} - Resultado de la transacción
     */
    async verifyTransaction(sessionId, sessionKey) {
        try {
            const response = await fetch(\`\${this.apiUrl}/verify?sessionId=\${sessionId}&sessionKey=\${sessionKey}\`, {
                method: 'GET'
            });

            if (!response.ok) {
                throw new Error(\`Error al verificar transacción: \${response.status}\`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error en CardnetService.verifyTransaction:', error);
            throw error;
        }
    }

    /**
     * Prepara los datos para el backend
     * @param {Object} data - Datos de la transacción
     * @returns {Object} - Datos preparados
     */
    preparePaymentData(data) {
        return {
            ordenId: data.ordenId || \`ORD-\${Date.now()}\`,
            total: data.total,
            impuestos: data.impuestos || 0,
            clienteNombre: data.nombre || "",
            clienteEmail: data.email || "",
            clienteTelefono: data.telefono || "",
            descripcion: data.descripcion || "Compra en Thelarte"
        };
    }
}`;

                // Enviar al servidor (simulación)
                console.log('Contenido de cardnetService.js generado');
            }
        });

    // Modificar transacciones.js para agregar las funciones del terminal
    fetch('/js/admin/transacciones.js')
        .then(response => response.text())
        .then(content => {
            if (!content.includes('procesarPagoTerminal')) {
                console.log('Modificando transacciones.js para agregar funciones de terminal');

                const terminalFunctions = `
// --- Funciones para el Terminal Verifone ---
async procesarPagoTerminal(transaccionId) {
    try {
        // 1. Obtener datos de la transacción
        const transaccion = await this.transaccionService.obtenerTransaccionPorId(transaccionId);
        if (!transaccion) {
            throw new Error("No se pudo obtener la transacción");
        }

        // 2. Mostrar modal de pago con terminal
        document.getElementById('terminalPaymentModal').classList.remove('hidden');
        document.getElementById('terminalPaymentStatus').classList.remove('hidden');
        document.getElementById('terminalPaymentComplete').classList.add('hidden');
        document.getElementById('terminalPaymentError').classList.add('hidden');
        document.getElementById('terminalStatusMessage').textContent = 'Enviando transacción al terminal...';
        document.getElementById('terminalInstructions').textContent = 'Por favor espere mientras se procesa la solicitud.';

        // 3. Preparar datos para Cardnet
        const paymentData = {
            ordenId: \`THELARTE-\${transaccionId}\`,
            total: transaccion.total,
            impuestos: transaccion.impuestos || 0,
            nombre: transaccion.cliente?.nombre
                ? \`\${transaccion.cliente.nombre} \${transaccion.cliente.apellido || ''}\`
                : 'Consumidor Final',
            descripcion: \`Factura #\${transaccion.numeroFactura || transaccion.id}\`
        };

        // 4. Iniciar proceso de pago con terminal
        await this.terminalPaymentProcessor.startPayment(
            paymentData,
            this.handleTerminalStatusChange.bind(this),
            this.handleTerminalPaymentComplete.bind(this, transaccionId),
            this.handleTerminalPaymentError.bind(this)
        );

    } catch (error) {
        console.error('Error al procesar pago con terminal:', error);
        this.handleTerminalPaymentError(error);
    }
}

handleTerminalStatusChange(statusData) {
    const statusMessage = document.getElementById('terminalStatusMessage');
    const instructions = document.getElementById('terminalInstructions');

    if (statusData.status === 'CREATED') {
        statusMessage.textContent = 'Transacción enviada al terminal';
        instructions.textContent = 'Por favor, pida al cliente que presente su tarjeta en el terminal.';
    } else if (statusData.status === 'PENDING') {
        statusMessage.textContent = 'Esperando acción en terminal';
        instructions.textContent = 'El terminal está procesando el pago.';
    } else if (statusData.status === 'CANCELLED_BY_USER') {
        this.handleTerminalPaymentError(new Error("Transacción cancelada por el usuario"));
    } else {
        statusMessage.textContent = statusData.message || 'Procesando...';
    }
}

handleTerminalPaymentComplete(transaccionId, statusData) {
    // Ocultar sección de estado y mostrar la de completado
    document.getElementById('terminalPaymentStatus').classList.add('hidden');
    document.getElementById('terminalPaymentComplete').classList.remove('hidden');

    if (statusData.authCode) {
        document.getElementById('terminalAuthCode').textContent =
            \`Código de autorización: \${statusData.authCode}\`;
    }

    // Actualizar la transacción en base de datos
    this.transaccionService.actualizarTransaccion(transaccionId, {
        estado: 'COMPLETADA',
        metodoPago: 'TARJETA',
        observaciones: \`Pago con tarjeta completado. Auth: \${statusData.authCode || 'N/A'}\`
    }).then(() => {
        // Recargar transacciones después de 2 segundos
        setTimeout(() => this.loadTransactions(), 2000);
    });
}

handleTerminalPaymentError(error) {
    document.getElementById('terminalPaymentStatus').classList.add('hidden');
    document.getElementById('terminalPaymentError').classList.remove('hidden');
    document.getElementById('terminalErrorMessage').textContent =
        error.message || 'Error desconocido al procesar el pago';

    console.error('Error en pago con terminal:', error);
}

cancelTerminalPayment() {
    if (this.terminalPaymentProcessor) {
        this.terminalPaymentProcessor.cancelTransaction();
    }
    this.closeTerminalPaymentModal();
}

closeTerminalPaymentModal() {
    document.getElementById('terminalPaymentModal').classList.add('hidden');
}
`;

                // En una aplicación real, aquí modificarías el archivo transacciones.js
                console.log('Funciones de terminal generadas para agregar a transacciones.js');
            }
        });
</script>
</body>
</html>